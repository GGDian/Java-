### **03 |** **授权服务：授权码和访问令牌的颁发流程是怎样的**

授权这个大动作的前提，肯定是小兔要去平台那里“备案”，也就是注册。注册完后，京东商家开放平台就会给小兔软件 app_id 和 app_secret 等信息，以方便后面授权时的各种身份校验。



注册的时候，第三方软件也会请求受保护资源的可访问范围。这个权限范围，就是 scope。



#### **颁发授权码** **code**

在这个过程中，授权服务需要完成两部分工作，分别是**准备工作**和**生成授权码 code**。

**准备工作**，包括验证基本信息、验证权限范围（第一次）和生成授权请求页面这三步。

**生成授权码 code** ，验证权限范围（第二次）、处理授权请求生成授权码 code 和重定向至第三方软件



#### **第四步，验证权限范围（第二次）**

这里的第二次验证权限范围，是用小明进行授权之后的权限，再次与小兔软件注册的权限做校验。那这里**为什么又要校验一次**呢？因为这相当于一次用户的输入权限。小明选择了一定的权限范围给到授权服务，对于权限的校验我们要重视对待，凡是输入性数据都会涉及到合法

性检查。



#### **第五步，处理授权请求，生成授权码 code。**

当小明同意授权之后，授权服务会校验响应类型 response_type 的值。response_type 有 code 和 token 两种类型的值。



在授权服务中，需要将生成的授权码 code 值与 app_id、user 进行关系映射。一个授权码 code，表示某一个用户给某一个第三方软件进行授权，需要将 code 值和这种映射关系保存起来，以便在生成访问令牌 access_token 时使用



OAuth 2.0 规范建议授权码 code 值有效期为 10 分钟，并且**一个授权码 code 只能被使用一次**。不过根据经验呢，在生产环境中 code 的有效期一般不会超过 5 分钟。



授权服务还需要**将生成的授权码 code 跟已经授权的权限范围 rscope 进行绑定并存储**，以便后续颁发访问令牌时，我们能够通过 code 值取出授权范围并与访问令牌绑定

#### **第六步，重定向至第三方软件**

生成授权码 code 值之后，授权服务需要将该 code 值告知第三方软件小兔。开始时我们提到，颁发授权码 code 是通过前端通信完成的，因此这里采用重定向的方式

### **颁发访问令牌** **access_token**

授权码，只是一个换取访问令牌 access_token 的临时凭证

这个过程主要包括验证第三方软件小兔是否存在、验证 code 值是否合法和生成 access_token 值这三大步

#### **第一步，验证第三方软件是否存在**

此时，接收到的 grant_type 的类型为 authorization_code。除了要校验 app_id 外，还要校验 app_secret。



#### **第二步，验证授权码 code 值是否合法**

授权服务在颁发授权码 code 的阶段已经将 code 值存储了起来，此时对比从 request 中 接收到的 code 值和从存储中取出来的 code 值

**确认过授权码 code 值有效以后，应该立刻从存储中删除当前的code 值**，以防止第三方软件恶意使用一个失窃的授权码 code 值来请求授权服务

#### **第三步，生成访问令牌 access_token 值**

生成规则 OAuth 2.0 规范中并没有明确规定，但必须符合三个原则：**唯一性、不连续性、不可猜性**。



需要将访问令牌 access_token 值存储起来，并将其与第三方软件的应用标识 app_id 和资源拥有者标识 user 进行关系映射。也就是说，**一个访问令牌access_token 表示某一个用户给某一个第三方软件进行授权**



**授权服务还需要将授权范围跟访问令牌 access_token 做绑定**。最后，还需要为该访问令牌设置一个过期时间 expires_in，比如 1 天。



正因为 OAuth 2.0 规范没有约束访问令牌内容的生成规则，所以我们有更高的自由度。我们既可以像 Demo 中那样生成一个 **UUID 形式**的数据存储起来，让授权服务和受保护资源共享该数据；也可以将一些**必要的信息通过结构化的处理放入令牌本身**。**我们将包含了一些信息的令牌，称为结构化令牌，简称 JWT**。



#### **使用刷新令牌**

在 OAuth 2.0 规范中，刷新令牌是一种特殊的授权许可类型，是嵌入在授权码许可类型下的一种特殊许可类型。

**第一步，接收刷新令牌请求，验证基本信息**

验证第三方软件是否存在；需要注意的是，这里需要同时验证刷新令牌是否存在，目的就是要保证传过来的刷新令牌的合法性。

我们还需要验证刷新令牌是否属于该第三方软件。授权服务是将颁发的刷新令牌与第三方软件、当时的授权用户绑定在一起的，因此这里需要判断该刷新令牌的归属合法性

**需要注意，一个刷新令牌被使用以后，授权服务需要将其废弃，并重新颁发一个刷新令牌。**

**第二步，重新生成访问令牌。**

授权还要有授权范围，**不能让第三方软件获得比注册时权限范围还大的授权，也不能获**

**得超出了用户授权的权限范围，始终确保最小权限安全原则。**比如，小明只为小兔软件

授予了获取当天订单的权限，那么小兔软件就不能访问小明店铺里面的历史订单数据。