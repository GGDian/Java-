Redis 只会使用 **C 字符串**作为字面量， 在大多数情况下，Redis 使用 **SDS（Simple Dynamic String）** 作为字符串表示。

比起 C 字符串，SDS 具有以下优点：

1. 常数复杂度获取字符串长度
2. 杜绝缓冲区溢出
3. 二进制安全
4. 兼容部分 C 字符串函数

## 链表

列表键的底层实现之一就是**链表**，当一个列表键包含了**数量比较多**的元素，又或者列表中包含的**元素都是比较长的字符串**时，Redis 就会使用链表作为列表键的底层实现



1. 每个链表节点由一个 **listNode** 结构来表示，每个节点都有一个指向前置节点和后置节点的指针，所以 Redis 的链表实现的是双端链表
2. 每个链表使用一个 list 结构来表示，这个结构带有表头节点指针、表尾节点指针，以及链表长度等信息
3. 链表表头节点的前置节点和表尾节点的后置节点都指向 NULL，所以Redis的链表实现是无环链表
4. 通过为链表设置不同的类型特定函数，Redis 的链表可以用于保存各种不用类型的值

## 字典

Redis 的数据库就是使用字典来作为底层实现的，字典也是哈希键的底层实现之一，当一个哈希键包含的**键值对**比较多，又或者键值对中的**元素都是比较长的字符串**时，Redis 就会使用字典作为哈希键的底层实现



Redis 的字典使用哈希表作为底层实现，一个哈希表里面可以有多个哈希表节点，而每个哈希表节点就保存了字典中的一个键值对



#### 哈希表

```c
typedef struct dicht{
    // 哈希表数组
     dictEntry **table;
    
    // 哈希表大小
     unsigned long size;
    
    // 哈希表大小掩码，用于计算索引值
    // 总是等于 size-1
    unsigned long sizemask;
    
    // 该哈希表已有节点的数量
    unsigned long used;
    
} dictht;
```

table 中每个元素都是一个指向 dictEntry 结构的**指针**

#### 哈希表节点

```c
typedef struct dictEntry{
    
    // 键
    void *key;
    
    // 值
    union{
      void *val;
      uint64_t u64;
      int64_t s64;
    }v;
    
    // 指向下个哈希表节点，形成链表
    struct dictEntry *next;
} dictEntry;
```

#### 字典

```c
typedef struct dict{
    
    // 类型特定函数
    dictType *type;
    
    // 私有数据，保存了需要传给那些类型特定函数的可选参数
    void *privdata;
    
    dictht ht[2];
    
    // rehash 索引
    // 当 rehash 不在进行时，值为 -1
    int rehashidx;
    
} dict;
```



Redis 的哈希表使用链地址法来**解决键冲突**，因为 dictEntry 节点组成的链表没有指向链表表尾的指针，所以为了速度考虑，**程序总是将新节点添加到链表的表头位置**（复杂度为 O(1)），排在其他已有节点的前面

### rehash

* 如果执行的是扩展操作，那么 ht[1] 的大小为第一个大于等于 ht[0].used*2 的 2 的 n 次方幂
* 如果执行的是收缩操作，那么 ht[1] 的大小为第一个大于等于 ht[0].used 的 2 的 n 次方幂

#### 渐进式 rehash

* 为 h[1] 分配空间
* 将索引计数器变量 rehashidx 的值设置为 0，表示 rehash 工作正式开始
* 每次对字典执行**添加、删除、查找或者更新**操作时，程序除了执行指定的操作以外，还会顺带将 ht[0] 哈希表在 rehashidx 索引上的所有键值对 rehash 到 ht[1]，当 rehashidx 工作完成之后，程序将 rehashidx 属性的值增一
* rehash 操作完成，将 rehashidx 属性的值设为 -1



## 跳跃表

跳跃表（skiplist）是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。

跳跃表支持平均 O(logN)、最坏 O(N) 复杂度的节点查找

Redis 使用跳跃表作为**有序集合键**（ZSET）的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中元素的成员（member）是比较长的字符串时，Redis 就会使用跳跃表来作为有序集合键的底层实现

* 跳跃表是有序集合的底层实现之一
* Redis 的跳跃表实现由 zskiplist 和 zskiplistNode 两个结构组成，其中 zskiplist 用于保存跳跃表信息（比如表头节点、表尾节点、长度），而 zskiplistNode 则用于表示跳跃表节点
* 每个跳跃表节点的层高都是 1 至 32 之间的随机数
* 在用一个跳跃表中，多个节点可以包含相同的分值，但每个节点的成员对象必须是唯一的
* 跳跃表的节点按照分值大小进行排序，当分值相同时，节点按照成员对象的大小进行排序



## 整数集合

整数集合（intset）是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现



