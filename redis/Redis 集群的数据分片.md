## Redis 集群的数据分片

Redis 集群没有使用**一致性hash**, 而是引入了 **哈希槽**的概念.

Redis 集群有**16384个**哈希槽,每个key通过**CRC16**校验后对16384取模**来决定放置哪个槽**.集群的每个节点负责**一部分hash槽**,举个例子,比如当前集群有3个节点,那么:

- 节点 A 包含 0 到 5500号哈希槽.
- 节点 B 包含5501 到 11000 号哈希槽.
- 节点 C 包含11001 到 16384号哈希槽.

这种结构**很容易添加或者删除节点**. 比如如果我想新添加个节点D, 我需要从节点 A, B, C中得部分槽到D上. 如果我想移除节点A,需要将A中的槽移到B和C节点上,然后将没有任何槽的A节点从集群中移除即可. 由于从一个节点将哈希槽移动到另一个节点并不会停止服务,所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.



## Redis 集群的主从复制模型

为了使在部分节点失败或者大部分节点无法通信的情况下集群仍然可用，所以**集群使用了主从复制模型,每个节点都会有N-1个复制品**.

在我们例子中具有A，B，C三个节点的集群,在没有复制模型的情况下,如果节点B失败了，**那么整个集群就会以为缺少5501-11000这个范围的槽而不可用**.

然而如果在集群创建的时候（或者过一段时间）我们为每个节点添加一个从节点A1，B1，C1,那么整个集群便有三个master节点和三个slave节点组成，这样在**节点B失败后，集群便会选举B1为新的主节点继续服务**，整个集群便不会因为槽找不到而不可用了

不过当B和B1 都失败后，集群是不可用的.